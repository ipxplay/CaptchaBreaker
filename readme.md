这是一个使用基于LeNet-5改进的CNN来识别某一种文本验证码的本科毕业项目。

参考@[kavishdahekar](<https://github.com/kavishdahekar/IITG-Captcha-Solver-OpenCV-TensorFlow>)

主要依赖:

- python 3.6.8
- opencv-python （opencv 4.x）
- keras
- tensorflow-xxx.whl（基于windows的优化版）



## 详细过程

整体思路如下流程图。

![](https://ws1.sinaimg.cn/large/005wR1ytgy1g2bm0eecd1j30960ixdge.jpg)

文本验证码的样例图片如下：

![](https://ws1.sinaimg.cn/large/005wR1ytgy1g2bl5jptavj307001tgm2.jpg)

观察以上验证码图片可以看出：这种验证码，由一层较浅的阴影轮廓以及其上的“椒盐噪声”组成。这种组合使得直接分隔出单个字符较为困难。一种直接的思路是各个击破，即先去除椒盐噪声，再从阴影轮廓中提取单个字符。

### 去除椒盐噪声

首先对图片灰度化，再二值化，其中，二值化使用Ostu算法，其代码如下。

```python
thresh = cv.threshold(gray, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU)[1]
```

二值化后的图像如下所示：

![](https://ws1.sinaimg.cn/large/005wR1ytgy1g2blofax4qj307001tglg.jpg)

对于以上图片，采用3x3的中值滤波对其进行去噪处理，处理后的图片如下所示。

![](https://ws1.sinaimg.cn/large/005wR1ytgy1g2blrm0cg0j307001twe9.jpg)

最后，采用一轮腐蚀和膨胀来处理细微的噪声点，使得图片更加干净些，如下。

![](https://ws1.sinaimg.cn/large/005wR1ytgy1g2bltakp70j307001tjr5.jpg)

### 分割字符

对以上图片，逐列统计白点的数量，得到如下直方图。

![](https://ws1.sinaimg.cn/large/005wR1ytgy1g2blvnb8vij30fe0bjgmj.jpg)

从上图中可以看到五个峰值，且这些峰值有一定的间距，又联想到验证码字符数固定为五个。这样，可以尝试使用聚类算法K-Means来找到这五个中心点，进而分离出五个字符。

将所有白点的行号和列号作为算法的输入特征，用来计算距离。设置中心点为五个，最终聚类得到的五个中心点极有可能在五个峰值所在的列。

用K-Means算法处理后，将各个分类用不同颜色着色，各个中心用白色着色，结果如下所示。

![](https://ws1.sinaimg.cn/large/005wR1ytgy1g2bm9jbrcej30fd04t74b.jpg)

从上图中可以看出，K-Means较好的将五个字符点分类。

分类后，测量各字符的平均宽度，得到45px。按这个宽度的一半，从各中心位置向两边裁剪出字符。

接下来，利用分离后的字符图片来训练网络。

### 训练网络

在LeNet-5两层卷积层的基础上，利用机器学习正交化的思想来逐步调优，即每次尽量只改变一个参数，使得模型优化的方向比较容易控制。

具体从以下方面进行：

1、首先是对输入数据进行数据扩充，可以有效降低过度拟合。对应Keras代码如下。

```python
aug = ImageDataGenerator(
        width_shift_range=0.1,
        height_shift_range=0.1,
    )
```

2、卷积核尺寸。测试两种:（5，5）、（3，3），意思是每层尺寸为5x5，或3x3。

3、卷积核个数。测试三种：（6，16）、（16，32）、（32，64），意思是第一层x个，第二层y个。

4、为进一步防止过度拟合，添加Dropout层，测试Dropout概率为0.2，0.25。

5、网络层次。测试（1+1）、（2+1）、（1+2）、（2+2）。其中（2+1）指两个卷积层后跟池化层再加一个卷积层后跟池化层。相连两个卷积层结构是一样的。

6、在每个激活函数后加Batch Normalization层。



## 结果

最终优化后的网络如下图所示。

![](https://ws1.sinaimg.cn/large/005wR1ytgy1g2bn4nuzrwj30xt0buq46.jpg)

结构为：

​	输入层：输入的图片为分割后的单个字符，图像尺寸为48x48，这是由于原始图像宽度为45，与它较接近的常用尺寸为48。

​       C1层：卷积层，卷积核的尺寸为3x3，卷积核个数为32，使用填充，所以输出的尺寸的不变。

​       C2层：卷积层，卷积核的尺寸为3x3，卷积核个数为32，使用填充，所以输出的尺寸的不变。

​       S3层：最大池化层，池化尺寸为2x2，池化步幅为2x2。

​       S3层之后有一个Dropout层，图中未画出，舍弃概率为0.2。

​       C4层：卷积层，卷积核的尺寸为3x3，卷积核个数为64，使用填充，所以输出的尺寸的不变。

​       C5层：卷积层，卷积核的尺寸为3x3，卷积核个数为64，使用填充，所以输出的尺寸的不变。

​       S6层：最大池化层，池化尺寸为2x2，池化步幅为2x2。

​       S6层之后有一个Dropout层，图中未画出，舍弃概率为0.2。

​       F7层：平铺层，三维feature map映射平埔为一维。

​       F8层：全连接层，共有512个神经单元。

​       F8层之后有一个Dropout层，图中未画出，舍弃概率固定为0.5，因为该层参数多。

​       输出层：Softmax分类器，28个分类的概率输出。



识别结果为

| 小图测试集正确率 | 所有大图正确率 | 平均时间/秒 |
| :--------------: | :------------: | :---------: |
|      96.3%       |     90.9%      |    0.118    |